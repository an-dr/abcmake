name: Build and Test Artifacts

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main", "feature/*", "develop" ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build

      - name: Configure CMake
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install

      - name: Build Package
        run: cmake --build build --config $BUILD_TYPE

      - name: Install Package
        run: cmake --install build --config $BUILD_TYPE --prefix ${{ github.workspace }}/install

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
            python-version: '3.x'

      - name: Generate release artifact
        run: |
          python scripts/generate_release.py --check || python scripts/generate_release.py
          echo "Generated release/ab.cmake"

      - name: Determine version/ref
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            REF="pr-${{ github.event.number }}"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            REF="${GITHUB_REF##*/}"
          else
            REF="${{ github.ref_name }}"
            REF="${REF//\//-}"  # Replace slashes with dashes for artifact names
          fi
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "Using reference: $REF"

      - name: Archive installed package
        run: |
          tar -czf abcmake-${{ steps.version.outputs.ref }}-install.tar.gz -C install .

      - name: Generate checksums
        run: |
          sha256sum release/ab.cmake > release/ab.cmake.sha256
          sha256sum abcmake-${{ steps.version.outputs.ref }}-install.tar.gz > abcmake-${{ steps.version.outputs.ref }}-install.tar.gz.sha256
          echo "Generated checksums"

      - name: Copy installation scripts
        run: |
          cp scripts/install.sh release/
          cp scripts/install.ps1 release/
          chmod +x release/install.sh

      - name: Upload single-file artifact
        uses: actions/upload-artifact@v4
        with:
          name: abcmake-single-file-${{ steps.version.outputs.ref }}
          path: |
            release/ab.cmake
            release/ab.cmake.sha256
          retention-days: 30

      - name: Upload installation scripts
        uses: actions/upload-artifact@v4
        with:
          name: abcmake-install-scripts-${{ steps.version.outputs.ref }}
          path: |
            release/install.sh
            release/install.ps1
          retention-days: 30

      - name: Upload installation package
        uses: actions/upload-artifact@v4
        with:
          name: abcmake-install-package-${{ steps.version.outputs.ref }}
          path: |
            abcmake-${{ steps.version.outputs.ref }}-install.tar.gz
            abcmake-${{ steps.version.outputs.ref }}-install.tar.gz.sha256
          retention-days: 30

      - name: Test installation scripts syntax
        run: |
          echo "Testing installation script syntax..."
          
          # Test bash script syntax
          bash -n scripts/install.sh
          echo "âœ… install.sh syntax is valid"
          
          # Test bash script help
          bash scripts/install.sh --help | grep -q "abcmake Installation Script"
          echo "âœ… install.sh help works"
          
          # Test PowerShell script if pwsh is available
          if command -v pwsh >/dev/null 2>&1; then
            pwsh -Command "& { . ./scripts/install.ps1; Show-Help }" | grep -q "abcmake Installation Script"
            echo "âœ… install.ps1 help works"
          else
            echo "â„¹ï¸  PowerShell not available, skipping PS1 tests"
          fi

      - name: Create test summary
        run: |
          echo "## ðŸš€ Build Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts have been built and are available for download:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Available Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Single File**: \`ab.cmake\` - Drop-in file for existing projects" >> $GITHUB_STEP_SUMMARY
          echo "- **Installation Package**: Complete package for system installation" >> $GITHUB_STEP_SUMMARY
          echo "- **Installation Scripts**: Platform-specific installation scripts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Testing the Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To test the installation scripts locally:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`abcmake-install-scripts-${{ steps.version.outputs.ref }}\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract and test:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Unix/Linux/macOS:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "bash install.sh --help" >> $GITHUB_STEP_SUMMARY
          echo "bash install.sh --user  # For user installation" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Windows:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`powershell" >> $GITHUB_STEP_SUMMARY
          echo "PowerShell -ExecutionPolicy Bypass -File install.ps1 -Help" >> $GITHUB_STEP_SUMMARY
          echo "PowerShell -ExecutionPolicy Bypass -File install.ps1 -User" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š File Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`ab.cmake\` | $(du -h release/ab.cmake | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "| Install Package | $(du -h abcmake-${{ steps.version.outputs.ref }}-install.tar.gz | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "| \`install.sh\` | $(du -h scripts/install.sh | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "| \`install.ps1\` | $(du -h scripts/install.ps1 | cut -f1) |" >> $GITHUB_STEP_SUMMARY

  test-installation-simulation:
    runs-on: ubuntu-latest
    needs: build-artifacts
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download installation package
        uses: actions/download-artifact@v4
        with:
          name: abcmake-install-package-pr-${{ github.event.number || github.ref_name }}
          path: ./test-artifacts

      - name: Download installation scripts  
        uses: actions/download-artifact@v4
        with:
          name: abcmake-install-scripts-pr-${{ github.event.number || github.ref_name }}
          path: ./test-scripts

      - name: Simulate installation process
        run: |
          echo "ðŸ§ª Simulating installation process..."
          
          # Test that artifacts exist
          echo "Checking artifact files..."
          ls -la test-artifacts/
          ls -la test-scripts/
          
          # Test installation script functionality (dry-run mode)
          echo "Testing installation script help..."
          bash test-scripts/install.sh --help
          
          # Test package extraction
          echo "Testing package extraction..."
          mkdir -p test-install
          cd test-artifacts
          PACKAGE_FILE=$(ls abcmake-*-install.tar.gz | head -1)
          echo "Extracting $PACKAGE_FILE"
          tar -tf "$PACKAGE_FILE" | head -10
          tar -xzf "$PACKAGE_FILE" -C ../test-install
          
          echo "Installation simulation completed successfully!"

      - name: Validate package contents
        run: |
          echo "ðŸ” Validating package contents..."
          
          # Check that essential files are present
          REQUIRED_FILES=(
            "test-install/share/cmake/abcmake/ab.cmake"
            "test-install/share/cmake/abcmake/abcmakeConfig.cmake"
            "test-install/share/cmake/abcmake/abcmakeConfigVersion.cmake"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ -f "$file" ]]; then
              echo "âœ… Found: $file"
            else
              echo "âŒ Missing: $file"
              exit 1
            fi
          done
          
          # Test that the main ab.cmake file is functional
          echo "Testing ab.cmake functionality..."
          grep -q "ABCMAKE ON" test-install/share/cmake/abcmake/ab.cmake
          echo "âœ… ab.cmake contains expected content"
          
          echo "Package validation completed successfully!"

      - name: Create test results summary
        run: |
          echo "## ðŸ§ª Installation Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Installation script syntax validation" >> $GITHUB_STEP_SUMMARY
          echo "- Installation script help functionality" >> $GITHUB_STEP_SUMMARY
          echo "- Package extraction and contents validation" >> $GITHUB_STEP_SUMMARY
          echo "- Essential files presence check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Package Contents" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find test-install -type f | sort >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The installation package is ready for testing!" >> $GITHUB_STEP_SUMMARY
